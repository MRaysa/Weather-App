<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <link rel="stylesheet" href="profile.css">
    <link rel="stylesheet" href="dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Navbar -->
    <header>
        <nav class="navbar">
            <div class="navbar-container">
                <div class="logo">
                    <img src="images/weather-logo.png" alt="Weather App Logo">
                </div>
                <div class="mobile-menu-icon" onclick="toggleMenu()">
                    <span>&#9776;</span>
                </div>
                <ul class="nav-links">
                    <li><a href="dashboard.html">Home</a></li>
                    <li><a href="average.html">Average</a></li>
                    <li><a href="#">Locations</a></li>
                    <li><a href="#" onclick="handleLogout()">Logout</a></li>
                </ul>
                <div class="avatar-button">
                    <div class="avatar-image">
                        <a href="./profile.html">
                            <img alt="User Avatar" id="navbarProfilePic" src="https://img.daisyui.com/images/stock/photo-1534528741775-53994a69daeb.webp" />
                        </a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Profile Section -->
    <div class="profile-container">
        <h2>My Profile</h2>

        <!-- Profile Picture -->
        <div class="profile-picture-container">
            <div class="profile-picture-wrapper">
                <img alt="User Avatar" id="profilePic" src="https://img.daisyui.com/images/stock/photo-1534528741775-53994a69daeb.webp" />
                <label for="uploadPic" class="upload-button">
                    <i class="fas fa-camera"></i>
                    <input type="file" id="uploadPic" accept="image/*" onchange="uploadProfilePicture()">
                </label>
            </div>
        </div>

        <!-- Profile Information -->
        <div class="profile-info">
            <div class="info-item">
                <span class="info-label">Name:</span>
                <span id="userName" class="info-value">Loading...</span>
            </div>
            <div class="info-item">
                <span class="info-label">Email:</span>
                <span id="userEmail" class="info-value">Loading...</span>
            </div>
            <div class="info-item">
                <span class="info-label">Default Location:</span>
                <span id="userLocation" class="info-value">Loading...</span>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="profile-actions">
            <button class="btn-edit" onclick="editProfile()">Edit Profile</button>
            <button class="btn-primary" onclick="editPassword()">Change Password</button>
            <button class="btn-delete" onclick="deleteAccount()">Delete Account</button>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const supabaseUrl = 'YOUR_SUPABASE_URL';
        const supabaseKey = 'YOUR_SUPABASE_KEY';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // Load user profile data
        async function loadProfile() {
            const { data: { user }, error } = await supabase.auth.getUser();
            
            if (error) {
                console.error('Error getting user:', error);
                window.location.href = 'index.html';
                return;
            }

            if (!user) {
                window.location.href = 'index.html';
                return;
            }

            // Get user profile data
            const { data: profileData, error: profileError } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', user.id)
                .single();

            if (profileError) {
                console.error('Error fetching profile:', profileError);
                return;
            }

            // Update UI with user data
            document.getElementById('userName').textContent = profileData.full_name || 'Not set';
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userLocation').textContent = profileData.default_location || 'Not set';

            // Update profile picture if available
            if (profileData.avatar_url) {
                document.getElementById('profilePic').src = profileData.avatar_url;
                document.getElementById('navbarProfilePic').src = profileData.avatar_url;
            }
        }

        // Upload profile picture
        async function uploadProfilePicture() {
            const fileInput = document.getElementById('uploadPic');
            const file = fileInput.files[0];
            
            if (!file) return;

            const { data: { user }, error: userError } = await supabase.auth.getUser();
            if (userError) {
                Swal.fire('Error', 'Please sign in to upload a profile picture', 'error');
                return;
            }

            // Generate unique filename
            const fileExt = file.name.split('.').pop();
            const fileName = `${user.id}-${Math.random().toString(36).substring(2, 15)}.${fileExt}`;
            const filePath = `avatars/${fileName}`;

            // Show loading
            Swal.fire({
                title: 'Uploading...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Upload file to Supabase Storage
            const { data: uploadData, error: uploadError } = await supabase.storage
                .from('profile-pictures')
                .upload(filePath, file, {
                    cacheControl: '3600',
                    upsert: true
                });

            if (uploadError) {
                Swal.fire('Error', 'Failed to upload image', 'error');
                return;
            }

            // Get public URL
            const { data: { publicUrl } } = supabase.storage
                .from('profile-pictures')
                .getPublicUrl(filePath);

            // Update profile with new avatar URL
            const { error: updateError } = await supabase
                .from('profiles')
                .update({ avatar_url: publicUrl })
                .eq('id', user.id);

            if (updateError) {
                Swal.fire('Error', 'Failed to update profile', 'error');
                return;
            }

            // Update UI
            document.getElementById('profilePic').src = publicUrl;
            document.getElementById('navbarProfilePic').src = publicUrl;

            Swal.fire('Success', 'Profile picture updated!', 'success');
        }

        // Edit profile
        async function editProfile() {
            const { data: { user }, error: userError } = await supabase.auth.getUser();
            if (userError) {
                Swal.fire('Error', 'Please sign in to edit your profile', 'error');
                return;
            }

            const { data: profileData, error: profileError } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', user.id)
                .single();

            if (profileError) {
                Swal.fire('Error', 'Failed to load profile data', 'error');
                return;
            }

            Swal.fire({
                title: 'Edit Profile',
                html: `
                    <input type="text" id="name" class="swal2-input" placeholder="Full Name" value="${profileData.full_name || ''}">
                    <input type="text" id="location" class="swal2-input" placeholder="Default Location" value="${profileData.default_location || ''}">
                `,
                confirmButtonText: 'Save',
                showCancelButton: true,
                preConfirm: async () => {
                    const name = document.getElementById('name').value;
                    const location = document.getElementById('location').value;

                    const { error } = await supabase
                        .from('profiles')
                        .update({ 
                            full_name: name,
                            default_location: location 
                        })
                        .eq('id', user.id);

                    if (error) {
                        Swal.showValidationMessage('Failed to update profile');
                    } else {
                        // Update UI
                        document.getElementById('userName').textContent = name;
                        document.getElementById('userLocation').textContent = location;
                    }
                }
            });
        }

        // Change password
        async function editPassword() {
            Swal.fire({
                title: 'Change Password',
                html: `
                    <input type="password" id="currentPassword" class="swal2-input" placeholder="Current Password">
                    <input type="password" id="newPassword" class="swal2-input" placeholder="New Password">
                    <input type="password" id="confirmPassword" class="swal2-input" placeholder="Confirm New Password">
                `,
                confirmButtonText: 'Update',
                showCancelButton: true,
                preConfirm: async () => {
                    const currentPassword = document.getElementById('currentPassword').value;
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;

                    if (newPassword !== confirmPassword) {
                        Swal.showValidationMessage('Passwords do not match');
                        return;
                    }

                    if (newPassword.length < 6) {
                        Swal.showValidationMessage('Password must be at least 6 characters');
                        return;
                    }

                    // In a real app, you would verify current password first
                    // Then update the password
                    const { error } = await supabase.auth.updateUser({
                        password: newPassword
                    });

                    if (error) {
                        Swal.showValidationMessage(error.message);
                    } else {
                        Swal.fire('Success', 'Password updated successfully!', 'success');
                    }
                }
            });
        }

        // Delete account
        async function deleteAccount() {
            const { value: confirm } = await Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to recover your account!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            });

            if (confirm) {
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                if (userError) {
                    Swal.fire('Error', 'Failed to delete account', 'error');
                    return;
                }

                // First delete from profiles table
                const { error: profileError } = await supabase
                    .from('profiles')
                    .delete()
                    .eq('id', user.id);

                if (profileError) {
                    console.error('Error deleting profile:', profileError);
                }

                // Then delete the auth user
                const { error: authError } = await supabase.auth.admin.deleteUser(user.id);

                if (authError) {
                    Swal.fire('Error', 'Failed to delete account', 'error');
                    return;
                }

                // Sign out and redirect
                await supabase.auth.signOut();
                window.location.href = 'index.html';
            }
        }

        // Logout handler
        async function handleLogout() {
            await supabase.auth.signOut();
            window.location.href = 'index.html';
        }

        // Toggle mobile menu
        function toggleMenu() {
            const navLinks = document.querySelector(".nav-links");
            navLinks.classList.toggle("active");
        }

        // Load profile when page loads
        document.addEventListener('DOMContentLoaded', loadProfile);
    </script>
</body>
</html>